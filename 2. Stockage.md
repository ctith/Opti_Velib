# Stockage des données dans HDFS

## Envoi des données vers AWS
```shell
ctith@L50T-048:/$ sudo scp -r -i NC_AWS_KEY.pem /mnt/c/Users/Fitec/IdeaProjects/velib/sql/data_output.csv ubuntu@54.194.196.141:/home/ubuntu
[sudo] Mot de passe de ctith :
data_output.csv                                                                                             100% 4940MB   5.4MB/s   15:17

ctith@L50T-048:/$ sudo scp -r -i NC_AWS_KEY.pem /mnt/c/Users/Fitec/IdeaProjects/velib/sql/data_lyon.csv ubuntu@54.194.196.141:/home/ubuntu
[sudo] Mot de passe de ctith :
data_lyon.csv                                                                                               100%  658MB   5.5MB/s   02:00
```

## Envoie des données de AWS vers HDFS

### Connexion en tant qu'user hdfs
```shell
ubuntu@ip-172-31-30-85:~$ ls
csv   data_lyon_2015.csv  data_lyon_2017.csv  data_lyon.csv    exo           kafka_2.11-1.0.0
data  data_lyon_2016.csv  data_lyon_2018.csv  data_output.csv  jdk1.8.0_161  meteo.py

ubuntu@ip-privée-aws:~$ sudo su hdfs
```

### Envoyer les fichiers csv vers hdfs
```shell
hdfs@ip-172-31-30-85:/home/ubuntu$ hdfs dfs -put data_output.csv /user/hadoop/
```

### Vérification du bon envoi des fichiers sur hdfs
```shell
ubuntu@ip-172-31-30-85:~$ sudo hdfs dfs -ls /user/hadoop
Found 6 items
-rw-r--r--   3 hdfs hdfs  689963590 2018-04-06 13:29 /user/hadoop/data_lyon.csv
-rw-r--r--   3 hdfs hdfs   17427610 2018-04-06 15:05 /user/hadoop/data_lyon_2015.csv
-rw-r--r--   3 hdfs hdfs  330184357 2018-04-06 15:05 /user/hadoop/data_lyon_2016.csv
-rw-r--r--   3 hdfs hdfs  278195237 2018-04-06 15:05 /user/hadoop/data_lyon_2017.csv
-rw-r--r--   3 hdfs hdfs   64156310 2018-04-06 15:05 /user/hadoop/data_lyon_2018.csv
-rw-r--r--   3 hdfs hdfs 5179740221 2018-04-06 13:34 /user/hadoop/data_output.csv
```

-----------------------------
# HiveQL

## Créer une BDD Hive
```SQL
CREATE DATABASE IF NOT EXISTS velib;
```

## Création des tables "contracts, stations, data" dans la BDD "velib" puis importation des fichiers csv selon le délimiteur ","

### Table contract
```SQL
CREATE TABLE IF NOT EXISTS velib.contract ( 
        contract_id INT,
        timestamp INT,
        contract_name STRING,
        commercial_name STRING,
        country_code STRING,
        cities STRING);
```

```SQL
alter table contract set SERDEPROPERTIES ('field.delim' = '\,');
LOAD DATA LOCAL INPATH '/home/ubuntu/contracts.csv' OVERWRITE INTO TABLE contract ;
```

### Table stations
```SQL
CREATE TABLE IF NOT EXISTS velib.stations ( 
        contract_id INT,
        station_number INT,
        status INT,
        bike_stands INT,
        bonus INT,
        banking INT,
        position STRING,
        address STRING,
        station_name STRING);
```

```SQL
alter table contract set SERDEPROPERTIES ('field.delim' = '\,');
LOAD DATA LOCAL INPATH '/home/ubuntu/stations_lyon.csv' OVERWRITE INTO TABLE stations ;
```

### Table data
```SQL
CREATE TABLE IF NOT EXISTS velib.data ( 
        timestamp INT,
        contract_id INT,
        station_number INT,
        available_bikes INT,
        available_bike_stands INT);
```
```SQL
alter table contract set SERDEPROPERTIES ('field.delim' = '\,');
LOAD DATA LOCAL INPATH '/home/ubuntu/data_lyon.csv' OVERWRITE INTO TABLE data ;
```




